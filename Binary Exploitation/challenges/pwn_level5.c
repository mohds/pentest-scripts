#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#define DEVURANDOM "/dev/urandom"

typedef unsigned char TYPE;

TYPE getRandU8()
{
    TYPE rnum = 0;
    int fd = open(DEVURANDOM, O_RDONLY);
    if (fd != -1)
    {
        (void) read(fd, (void *)&rnum, sizeof(TYPE));
        (void) close(fd);
    }
    return rnum;
}

static char *rand_string(char *str, size_t size)
{
    const char charset[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    if (size) {
        --size;
        for (size_t n = 0; n < size; n++) {
            int key = getRandU8() % (int) (sizeof charset - 1);
            str[n] = charset[key];
        }
        str[size] = '\0';
    }
    return str;
}

char* rand_string_alloc(size_t size)
{
     char *s = malloc(size + 1);
     if (s) {
         rand_string(s, size+1);
     }
     return s;
}

char checkpass(char * password){
	char buf[255];
	memset(buf, 0, sizeof(buf));
	read(0,buf,254);
	printf(buf);
	if (!strncmp(buf, password,6)){
		return 1;
	} else {
		return 0;
	}
}

void printflag(){
	FILE * flagfile;
	char flag[50];
	memset(flag, 0, sizeof(flag));
	flagfile = fopen("/home/pwn/flag/pwn_level5.flag", "r");
	if (flagfile) {
		fscanf(flagfile,"%45s",flag);
	} else {
		puts("Cant open flag file");
		exit(1);
	}
	puts(flag);
}

int main( int argc, char* argv[]){
	//generate a password
	char* password = rand_string_alloc(6);

	//ask for password
	printf("Please enter password:\n");
	if (checkpass(password)){
		puts("Here is the flag!\n");
		printflag();
	} else {
		puts("Wrong pass");
	}
	free(password);
}